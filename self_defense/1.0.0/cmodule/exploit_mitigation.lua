require("waffi.headers.windows")
local lk32 = require("waffi.windows.kernel32")
local ffi = require("ffi")

local strategy = {}

strategy.HARDENED_PROFILE = {
    data_execution_prevention = {
        Enable = true,
        Permanent = true,
        DisableAtlThunkEmulation = true,
    },
    address_space_layout_randomization = {
        EnableBottomUpRandomization = true,
        EnableForceRelocateImages = true,
        EnableHighEntropy = true,
        DisallowStrippedImages = true,
    },
}

--- Gets the last error as a string.
---@return string error
local function get_last_error()
    return tostring(lk32.GetLastError())
end

ffi.cdef([[
typedef enum _PROCESS_MITIGATION_POLICY {
    ProcessDEPPolicy,
    ProcessASLRPolicy,
    ProcessDynamicCodePolicy,
    ProcessStrictHandleCheckPolicy,
    ProcessSystemCallDisablePolicy,
    ProcessMitigationOptionsMask,
    ProcessExtensionPointDisablePolicy,
    ProcessControlFlowGuardPolicy,
    ProcessSignaturePolicy,
    ProcessFontDisablePolicy,
    ProcessImageLoadPolicy,
    ProcessSystemCallFilterPolicy,
    ProcessPayloadRestrictionPolicy,
    ProcessChildProcessPolicy,
    ProcessSideChannelIsolationPolicy,
    ProcessUserShadowStackPolicy,
    ProcessRedirectionTrustPolicy,
    ProcessUserPointerAuthPolicy,
    ProcessSEHOPPolicy,
    MaxProcessMitigationPolicy
} PROCESS_MITIGATION_POLICY, *PPROCESS_MITIGATION_POLICY;

typedef struct _PROCESS_MITIGATION_DEP_POLICY {
    union {
        DWORD Flags;
        struct {
            DWORD Enable : 1;
            DWORD DisableAtlThunkEmulation : 1;
            DWORD ReservedFlags : 30;
        };
    };
    BOOLEAN Permanent;
} PROCESS_MITIGATION_DEP_POLICY, *PPROCESS_MITIGATION_DEP_POLICY;

typedef struct _PROCESS_MITIGATION_ASLR_POLICY {
    union {
        DWORD Flags;
        struct {
            DWORD EnableBottomUpRandomization : 1;
            DWORD EnableForceRelocateImages : 1;
            DWORD EnableHighEntropy : 1;
            DWORD DisallowStrippedImages : 1;
            DWORD ReservedFlags : 28;
        };
    };
} PROCESS_MITIGATION_ASLR_POLICY, *PPROCESS_MITIGATION_ASLR_POLICY;
]])

local mitigation_policies = {
    data_execution_prevention = {
        id = ffi.C.ProcessDEPPolicy,
        schema = "PROCESS_MITIGATION_DEP_POLICY",
    },
    address_space_layout_randomization = {
        id = ffi.C.ProcessASLRPolicy,
        schema = "PROCESS_MITIGATION_ASLR_POLICY",
    },
}

ffi.cdef([[
BOOL SetProcessMitigationPolicy(PROCESS_MITIGATION_POLICY MitigationPolicy,
                                PVOID lpBuffer, SIZE_T dwLength);

BOOL GetProcessMitigationPolicy(HANDLE hProcess,
                                PROCESS_MITIGATION_POLICY MitigationPolicy,
                                PVOID lpBuffer, SIZE_T dwLength);
]])

---Applies the `config` for the specified mitigation policy `name`
---and returns the previous configuration.
---@param name string name of the mitigation policy
---@param config table configuration to apply
---@return table|nil old configuration
---@return string|nil error string explaining the problem, if any
function strategy.apply_policy(name, config)
    local policy = mitigation_policies[name]
    local buf = ffi.new(policy.schema)
    local len = ffi.sizeof(policy.schema)
    local process = lk32.GetCurrentProcess()
    local ret = ffi.C.GetProcessMitigationPolicy(process, policy.id, buf, len)
    if not ret then
        return nil, get_last_error()
    end
    local old_config = {}
    for key, value in pairs(config) do
        old_config[key] = (buf[key] ~= 0)
        buf[key] = value
    end
    ret = ffi.C.SetProcessMitigationPolicy(policy.id, buf, len)
    if not ret then
        return nil, get_last_error()
    end
    return old_config
end

function strategy.apply(profile)
    local old_profile = {}
    for policy_name, policy_params in pairs(profile) do
        local old_params, err =
            strategy.apply_policy(policy_name, policy_params)
        if not old_params then
            -- TODO: rollback all applied policies and return error
            return nil, err
        end
        old_profile[policy_name] = old_params
    end
    return old_profile
end

return strategy
